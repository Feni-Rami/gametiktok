<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Escape Rings ‚Äì Final Stable</title>
<style>
html,body{
  margin:0;
  background:#020204;
  overflow:hidden;
  font-family:Arial,Helvetica,sans-serif;
}
canvas{display:block}

/* HUD */
#hud{
  position:fixed;
  top:14px;
  left:0; right:0;
  display:flex;
  justify-content:space-between;
  padding:0 20px;
  font-size:18px;
  pointer-events:none;
}
.orange{color:#ff9f00}
.blue{color:#00baff}

/* Overlays */
.overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.75);
  display:flex;
  align-items:center;
  justify-content:center;
  flex-direction:column;
  color:#fff;
  font-size:28px;
  letter-spacing:1px;
  z-index:10;
}
.hidden{display:none}
.small{font-size:18px;opacity:.7}
</style>
</head>
<body>

<div id="hud">
  <div class="orange">ORANGE <span id="scoreO">0</span></div>
  <div class="blue">BLUE <span id="scoreB">0</span></div>
</div>

<div id="start" class="overlay">
  <div><span class="orange">ORANGE</span> VS <span class="blue">BLUE</span></div>
  <div class="small">Tap to start</div>
</div>

<div id="end" class="overlay hidden">
  <div id="winner"></div>
  <div class="small">Restarting‚Ä¶</div>
</div>

<canvas id="c"></canvas>

<script>
/* ================= SETUP ================= */
const canvas = document.getElementById("c");
const ctx = canvas.getContext("2d");
function resize(){canvas.width=innerWidth;canvas.height=innerHeight}
resize();addEventListener("resize",resize);

const CX=()=>canvas.width/2;
const CY=()=>canvas.height/2;

/* ================= AUDIO ================= */
let audioCtx, audioReady=false, pitchLevel=0, cameraPulse=0;

function initAudio(){
  audioCtx=new (window.AudioContext||window.webkitAudioContext)();
  audioReady=true;
}

/* ‚úÖ SON CHOISI (NE PAS MODIFIER) */
function play(freq, dur, gain){
  if(!audioReady) return;

  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();

  o.type = "triangle";
  o.frequency.value = freq;

  g.gain.setValueAtTime(0, audioCtx.currentTime);
  g.gain.linearRampToValueAtTime(gain, audioCtx.currentTime + 0.01);
  g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + dur);

  o.connect(g);
  g.connect(audioCtx.destination);

  o.start();
  o.stop(audioCtx.currentTime + dur);
}

const bounceSound=()=>play(220,.04,.08);
const hitSound=()=>play(300,.04,.1);
const exitSound=()=>{
  play(520+pitchLevel*120,.09,.18);
  pitchLevel++;
  cameraPulse=1;
};

/* ================= SETTINGS ================= */
const RING_COUNT=13;
const GAP_SIZE=Math.PI/7;
const RING_THICKNESS=4;
const SAFE_MARGIN=-45;

const BALL_RADIUS=3.5;
const BALL_SPEED=6.2;
const BALL_COUNT=2;

const BASE_ROT_SPEED=.0025;
const BOUNCE_RANDOM_ANGLE=Math.PI/18;

function getMaxRadius(){
  return Math.min(canvas.width,canvas.height)/2 - SAFE_MARGIN;
}

/* ================= STATE ================= */
let rings=[], balls=[], started=false;
let scoreO=0, scoreB=0;

/* ================= INIT ================= */
function reset(){
  rings=[]; balls=[]; pitchLevel=0;
  scoreO=0; scoreB=0;
  updateScore();

  const spacing=getMaxRadius()/(RING_COUNT+8);

  for(let i=0;i<RING_COUNT;i++){
    rings.push({
      r:spacing*(i+3),
      gap:Math.random()*Math.PI*2,
      rot:BASE_ROT_SPEED*(i+1)
    });
  }

  for(let i=0;i<BALL_COUNT;i++){
    const a=Math.random()*Math.PI*2;
    balls.push({
      x:CX()+Math.cos(a)*30,
      y:CY()+Math.sin(a)*30,
      vx:Math.cos(a+i)*BALL_SPEED,
      vy:Math.sin(a+i)*BALL_SPEED,
      color:i===0?"orange":"blue",
      prevD:0 // üîë FIX TUNNELING
    });
  }
}

/* ================= UI ================= */
const scoreOEl=document.getElementById("scoreO");
const scoreBEl=document.getElementById("scoreB");
function updateScore(){
  scoreOEl.textContent=scoreO;
  scoreBEl.textContent=scoreB;
}

/* ================= START ================= */
document.getElementById("start").onclick=()=>{
  initAudio();
  reset();
  started=true;
  document.getElementById("start").classList.add("hidden");
};

/* ================= HELPERS ================= */
const dist=(ax,ay,bx,by)=>Math.hypot(ax-bx,ay-by);
const angle=(x,y)=>Math.atan2(y-CY(),x-CX());
function norm(a){
  while(a<-Math.PI)a+=Math.PI*2;
  while(a>Math.PI)a-=Math.PI*2;
  return a;
}

/* ================= UPDATE ================= */
function update(){
  if(!started) return;

  /* m√©morise distance pr√©c√©dente (FIX) */
  for(const b of balls){
    b.prevD = dist(b.x,b.y,CX(),CY());
  }

  for(const b of balls){
    b.x+=b.vx;
    b.y+=b.vy;
  }

  /* Ball ‚Üî Ball */
  if(balls.length===2){
    const a=balls[0], b=balls[1];
    const d=dist(a.x,a.y,b.x,b.y);
    if(d<BALL_RADIUS*2){
      const nx=(b.x-a.x)/d, ny=(b.y-a.y)/d;
      const p=(a.vx*nx+a.vy*ny-b.vx*nx-b.vy*ny);
      a.vx-=p*nx; a.vy-=p*ny;
      b.vx+=p*nx; b.vy+=p*ny;
      hitSound();
    }
  }

  /* Rings */
  for(let i=rings.length-1;i>=0;i--){
    const ring=rings[i];
    ring.gap+=ring.rot;

    for(const b of balls){
      const d=dist(b.x,b.y,CX(),CY());
      const a=angle(b.x,b.y);
      const diff=Math.abs(norm(a-ring.gap));

      const wasInside=b.prevD<ring.r;
      const isOutside=d>ring.r;

      /* ‚úÖ PASSAGE VALIDE (m√™me si on saute le rayon) */
      if(wasInside && isOutside && diff<GAP_SIZE/2){
        exitSound();
        if(b.color==="orange") scoreO++;
        else scoreB++;
        updateScore();
        rings.splice(i,1);
        return;
      }

      /* Collision classique */
      if(Math.abs(d-ring.r)<BALL_RADIUS+RING_THICKNESS && diff>GAP_SIZE/2){
        const nx=(b.x-CX())/d, ny=(b.y-CY())/d;
        const dot=b.vx*nx+b.vy*ny;
        const ang=Math.atan2(b.vy-2*dot*ny,b.vx-2*dot*nx);
        const rand=(Math.random()*2-1)*BOUNCE_RANDOM_ANGLE;
        b.vx=Math.cos(ang+rand)*BALL_SPEED;
        b.vy=Math.sin(ang+rand)*BALL_SPEED;
        bounceSound();
      }
    }
  }

  /* Fin */
  if(rings.length===0){
    const end=document.getElementById("end");
    const w=document.getElementById("winner");
    w.textContent = scoreO>scoreB ? "ORANGE WINS" :
                    scoreB>scoreO ? "BLUE WINS" : "DRAW";
    w.className = scoreO>=scoreB ? "orange" : "blue";
    end.classList.remove("hidden");
    setTimeout(()=>{
      end.classList.add("hidden");
      reset();
    },2000);
  }

  cameraPulse*=.9;
}

/* ================= DRAW ================= */
function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.save();
  ctx.translate(CX(),CY());
  ctx.scale(1+cameraPulse*.05,1+cameraPulse*.05);
  ctx.translate(-CX(),-CY());

  const bg=ctx.createRadialGradient(CX(),CY(),60,CX(),CY(),canvas.width);
  bg.addColorStop(0,"#0b0d18");
  bg.addColorStop(1,"#020204");
  ctx.fillStyle=bg;
  ctx.fillRect(0,0,canvas.width,canvas.height);

  ctx.lineWidth=RING_THICKNESS;
  ctx.shadowBlur=14;

  for(let i=0;i<rings.length;i++){
    const hue=280+i*6;
    ctx.strokeStyle=`hsl(${hue},90%,65%)`;
    ctx.shadowColor=ctx.strokeStyle;
    ctx.beginPath();
    ctx.arc(
      CX(),CY(),
      rings[i].r,
      rings[i].gap+GAP_SIZE/2,
      rings[i].gap+Math.PI*2-GAP_SIZE/2
    );
    ctx.stroke();
  }
  ctx.shadowBlur=0;

  for(const b of balls){
    ctx.beginPath();
    ctx.arc(b.x,b.y,BALL_RADIUS,0,Math.PI*2);
    ctx.fillStyle=b.color==="orange"?"#ff9f00":"#00baff";
    ctx.fill();
  }
  ctx.restore();
}

/* ================= LOOP ================= */
(function loop(){
  update();
  draw();
  requestAnimationFrame(loop);
})();
</script>
</body>
</html>

<!-- <!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Escape Rings ‚Äì Rings Only Update</title>
<style>
html,body{
  margin:0;
  background:#020204;
  overflow:hidden;
  font-family:Arial,Helvetica,sans-serif;
}
canvas{display:block}
#top{
  position:fixed;
  top:18px;
  left:0;right:0;
  text-align:center;
  color:#ffffffcc;
  font-size:18px;
  pointer-events:none;
}
#start{
  position:fixed;
  inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
  background:#020204;
  color:#fff;
  font-size:22px;
  letter-spacing:1px;
  z-index:10;
}
</style>
</head>
<body>

<div id="top">Only one path works</div>
<div id="start">TAP TO START</div>
<canvas id="c"></canvas>

<script>
/* ================= SETUP ================= */
const canvas = document.getElementById("c");
const ctx = canvas.getContext("2d");
function resize(){
  canvas.width = innerWidth;
  canvas.height = innerHeight;
}
resize();
addEventListener("resize", resize);

const CX = () => canvas.width/2;
const CY = () => canvas.height/2;

/* ================= AUDIO ================= */
let audioCtx;
let audioReady = false;
let pitchLevel = 0;
let cameraPulse = 0;

function initAudio(){
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  audioReady = true;
}

function play(freq, dur, gain){
  if(!audioReady) return;

  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();

  o.type = "triangle"; // ‚¨ÖÔ∏è plus doux que sine
  o.frequency.value = freq;

  g.gain.setValueAtTime(0, audioCtx.currentTime);
  g.gain.linearRampToValueAtTime(gain, audioCtx.currentTime + 0.01);
  g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + dur);

  o.connect(g);
  g.connect(audioCtx.destination);

  o.start();
  o.stop(audioCtx.currentTime + dur);
}

// function play(freq, dur, gain){
//   if(!audioReady) return;

//   const o = audioCtx.createOscillator();
//   const g = audioCtx.createGain();
//   const f = audioCtx.createBiquadFilter();

//   o.type = "sine";
//   o.frequency.value = freq;

//   f.type = "highpass";
//   f.frequency.value = 800; // ‚¨ÖÔ∏è effet verre

//   g.gain.setValueAtTime(gain, audioCtx.currentTime);
//   g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + dur);

//   o.connect(f);
//   f.connect(g);
//   g.connect(audioCtx.destination);

//   o.start();
//   o.stop(audioCtx.currentTime + dur);
// }
  
  
const bounceSound = () => play(220, 0.04, 0.08);
const hitSound    = () => play(300, 0.04, 0.1);
const exitSound   = () => {
  play(520 + pitchLevel*120, 0.09, 0.18);
  pitchLevel++;
  cameraPulse = 1;
};

/* ================= SETTINGS ================= */
const RING_COUNT = 13; // ‚¨ÖÔ∏è plus d‚Äôanneaux
const GAP_SIZE = Math.PI / 7;
const RING_THICKNESS = 4;

/* Mobile scaling */
const SAFE_MARGIN = -45;
function getMaxRadius(){
  return Math.min(canvas.width, canvas.height) / 2 - SAFE_MARGIN;
}

/* Balls (INCHANG√â) */
const BALL_RADIUS = 3.5;
const BALL_SPEED = 6.2;
const BALL_COUNT = 2;

/* Rotation */
const BASE_ROT_SPEED = 0.0025;

/* Randomness */
const BOUNCE_RANDOM_ANGLE = Math.PI / 18;

/* ================= STATE ================= */
let rings = [];
let balls = [];
let started = false;

/* ================= INIT ================= */
function reset(){
  rings = [];
  balls = [];
  pitchLevel = 0;

  const maxR = getMaxRadius();
  const spacing = maxR / (RING_COUNT + 8); // ‚¨ÖÔ∏è anneaux plus rapproch√©s

  for(let i=0;i<RING_COUNT;i++){
    rings.push({
      r: spacing * (i + 3),
      gap: Math.random() * Math.PI * 2,
      rot: BASE_ROT_SPEED * (i + 1)
    });
  }

  /* Balls ‚Äî EXACTEMENT COMME TON CODE */
  for(let i=0;i<BALL_COUNT;i++){
    const a = Math.random() * Math.PI * 2;
    balls.push({
      x: CX() + Math.cos(a) * 30,
      y: CY() + Math.sin(a) * 30,
      vx: Math.cos(a + i) * BALL_SPEED,
      vy: Math.sin(a + i) * BALL_SPEED,
      color: i === 0 ? "#ff9f00" : "#00baff"
    });
  }
}

/* ================= START ================= */
document.getElementById("start").addEventListener("click", ()=>{
  initAudio();
  reset();
  started = true;
  document.getElementById("start").style.display = "none";
});

/* ================= HELPERS ================= */
const dist = (ax,ay,bx,by)=>Math.hypot(ax-bx,ay-by);
const angle = (x,y)=>Math.atan2(y-CY(), x-CX());
function norm(a){
  while(a<-Math.PI) a+=Math.PI*2;
  while(a> Math.PI) a-=Math.PI*2;
  return a;
}

/* ================= UPDATE ================= */
function update(){
  if(!started) return;

  for(const b of balls){
    b.x += b.vx;
    b.y += b.vy;
  }

  /* Ball ‚Üî Ball (INCHANG√â) */
  if(balls.length === 2){
    const a = balls[0], b = balls[1];
    const d = dist(a.x,a.y,b.x,b.y);
    if(d < BALL_RADIUS*2){
      const nx = (b.x-a.x)/d;
      const ny = (b.y-a.y)/d;
      const p = (a.vx*nx + a.vy*ny - b.vx*nx - b.vy*ny);
      a.vx -= p*nx; a.vy -= p*ny;
      b.vx += p*nx; b.vy += p*ny;
      hitSound();
    }
  }

  /* Rings */
  for(let i=rings.length-1;i>=0;i--){
    const ring = rings[i];
    ring.gap += ring.rot;

    for(const b of balls){
      const d = dist(b.x,b.y,CX(),CY());
      const a = angle(b.x,b.y);

      if(Math.abs(d - ring.r) < BALL_RADIUS + RING_THICKNESS){
        const diff = Math.abs(norm(a - ring.gap));

        if(diff > GAP_SIZE/2){
          const nx = (b.x-CX())/d;
          const ny = (b.y-CY())/d;
          const dot = b.vx*nx + b.vy*ny;
          const ang = Math.atan2(b.vy - 2*dot*ny, b.vx - 2*dot*nx);
          const rand = (Math.random()*2 - 1) * BOUNCE_RANDOM_ANGLE;
          b.vx = Math.cos(ang + rand) * BALL_SPEED;
          b.vy = Math.sin(ang + rand) * BALL_SPEED;
          bounceSound();
        } else {
          exitSound();
          rings.splice(i,1);
          return;
        }
      }
    }
  }

  if(rings.length === 0){
    setTimeout(reset, 1200);
  }

  cameraPulse *= 0.9;
}

/* ================= DRAW ================= */
function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  const pulse = 1 + cameraPulse * 0.05;
  ctx.save();
  ctx.translate(CX(), CY());
  ctx.scale(pulse, pulse);
  ctx.translate(-CX(), -CY());

  const bg = ctx.createRadialGradient(CX(),CY(),60,CX(),CY(),canvas.width);
  bg.addColorStop(0,"#0b0d18");
  bg.addColorStop(1,"#020204");
  ctx.fillStyle = bg;
  ctx.fillRect(0,0,canvas.width,canvas.height);

  /* Rings ‚Äî NOUVELLE COULEUR */
  ctx.lineWidth = RING_THICKNESS;
  ctx.shadowBlur = 14;

  for(let i=0;i<rings.length;i++){
    const ring = rings[i];
    const hue = 280 + i*6; // violet ‚Üí rose
    ctx.strokeStyle = `hsl(${hue},90%,65%)`;
    ctx.shadowColor = ctx.strokeStyle;

    ctx.beginPath();
    ctx.arc(
      CX(), CY(),
      ring.r,
      ring.gap + GAP_SIZE/2,
      ring.gap + Math.PI*2 - GAP_SIZE/2
    );
    ctx.stroke();
  }

  ctx.shadowBlur = 0;

  /* Balls (INCHANG√â) */
  for(const b of balls){
    ctx.beginPath();
    ctx.arc(b.x,b.y,BALL_RADIUS,0,Math.PI*2);
    ctx.fillStyle = b.color;
    ctx.fill();

    ctx.beginPath();
    ctx.arc(b.x,b.y,BALL_RADIUS*2.3,0,Math.PI*2);
    ctx.strokeStyle = b.color + "66";
    ctx.lineWidth = 2;
    ctx.stroke();
  }

  ctx.restore();
}

/* ================= LOOP ================= */
function loop(){
  update();
  draw();
  requestAnimationFrame(loop);
}
loop();
</script>
</body>
</html>
 -->
