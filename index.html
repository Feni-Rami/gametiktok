<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Ball Arena – Final Physics</title>
<style>
html,body{
  margin:0;
  background:#050509;
  overflow:hidden;
  font-family:Arial,Helvetica,sans-serif;
}
canvas{display:block}

#audioUnlock{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.9);
  display:flex;
  align-items:center;
  justify-content:center;
  color:#fff;
  font-size:22px;
  z-index:20;
}

#hud{
  position:fixed;
  top:calc(50% - 260px);
  left:0; right:0;
  display:flex;
  justify-content:center;
  gap:100px;
  font-size:20px;
  font-weight:700;
  pointer-events:none;
}
.score{transition:.2s}
.score.pulse{transform:scale(1.3);filter:drop-shadow(0 0 14px currentColor)}
.orange{color:#ffb000}
.blue{color:#00c8ff}
</style>
</head>
<body>

<div id="audioUnlock">TAP TO ENABLE SOUND</div>

<div id="hud">
  <div class="orange score">ORANGE <span id="sO">0</span></div>
  <div class="blue score">BLUE <span id="sB">0</span></div>
</div>

<canvas id="c"></canvas>

<script>
/* ================= SETUP ================= */
const c=document.getElementById("c");
const ctx=c.getContext("2d");
function resize(){c.width=innerWidth;c.height=innerHeight}
resize();addEventListener("resize",resize);

const ARENA=420;
const WALL=10;
const R=18;
const SPEED=4.8;
const WIN=5;

/* ================= AUDIO ================= */
let audioCtx,audioReady=false,lastSound=0;
document.getElementById("audioUnlock").addEventListener("pointerdown",()=>{
  audioCtx=new (window.AudioContext||window.webkitAudioContext)();
  audioCtx.resume().then(()=>{
    audioReady=true;
    play(180,0.05,0.08);
    audioUnlock.remove();
  });
},{once:true});

function play(f,d,g){
  if(!audioReady) return;
  const now=audioCtx.currentTime;
  if(now-lastSound<0.035) return;
  lastSound=now;

  const o=audioCtx.createOscillator();
  const a=audioCtx.createGain();
  o.type="triangle";
  o.frequency.value=f;
  a.gain.setValueAtTime(0,now);
  a.gain.linearRampToValueAtTime(g,now+.01);
  a.gain.exponentialRampToValueAtTime(0.0001,now+d);
  o.connect(a);a.connect(audioCtx.destination);
  o.start();o.stop(now+d);
}

/* ================= STATE ================= */
let balls=[], knife=null;
let scoreO=0, scoreB=0;
let nextKnife=performance.now()+5000;
let winner=null;
let blood=[], ripples=[], pickupFX=[];

/* ================= BALL ================= */
function spawn(color,x){
  return{
    x, y:Math.random()*140-70,
    vx:color==="orange"?SPEED:-SPEED,
    vy:(Math.random()*2-1)*SPEED,
    color, knife:false, knifeT:0, rot:0,
    trail:[]
  };
}
balls=[spawn("orange",-140),spawn("blue",140)];

/* ================= UPDATE ================= */
function update(){
  if(winner) return;

  const now=performance.now();
  if(!knife && now>nextKnife){
    knife={x:Math.random()*220-110,y:Math.random()*220-110,t:300};
    nextKnife=now+(5000+Math.random()*4000);
  }
  if(knife && --knife.t<=0) knife=null;

  for(const b of balls){
    b.trail.unshift({x:b.x,y:b.y});
    if(b.trail.length>22) b.trail.pop();

    b.x+=b.vx; b.y+=b.vy;

    if(Math.abs(b.x)>ARENA/2-R){
      b.x=Math.sign(b.x)*(ARENA/2-R);
      b.vx*=-1; ripples.push({x:b.x,y:b.y,r:0,a:1});
      play(220,0.04,0.07);
    }
    if(Math.abs(b.y)>ARENA/2-R){
      b.y=Math.sign(b.y)*(ARENA/2-R);
      b.vy*=-1; ripples.push({x:b.x,y:b.y,r:0,a:1});
      play(220,0.04,0.07);
    }

    if(b.knife){
      b.knifeT--; b.rot+=0.5;
      if(b.knifeT<=0) b.knife=false;
    }
  }

  /* ==== BALL vs BALL (FIXED PHYSICS) ==== */
  const a=balls[0], b=balls[1];
  const dx=b.x-a.x, dy=b.y-a.y;
  const d=Math.hypot(dx,dy);
  if(d<2*R){
    const nx=dx/d, ny=dy/d;
    const overlap=2*R-d+0.5;
    a.x-=nx*overlap/2; a.y-=ny*overlap/2;
    b.x+=nx*overlap/2; b.y+=ny*overlap/2;

    const dvx=b.vx-a.vx, dvy=b.vy-a.vy;
    const vn=dvx*nx+dvy*ny;
    if(vn<0){
      const impulse=vn;
      a.vx+=impulse*nx; a.vy+=impulse*ny;
      b.vx-=impulse*nx; b.vy-=impulse*ny;
    }

    if(a.knife&&!b.knife){
      scoreO++; b.x=140; b.y=0; b.vx=-SPEED; b.vy=SPEED*Math.random();
      a.knife=false; play(90,0.35,0.35);
    }else if(b.knife&&!a.knife){
      scoreB++; a.x=-140; a.y=0; a.vx=SPEED; a.vy=SPEED*Math.random();
      b.knife=false; play(90,0.35,0.35);
    }else if(a.knife&&b.knife){
      a.knife=b.knife=false; play(300,0.05,0.1);
    }else{
      play(260,0.04,0.06);
    }

    sO.textContent=scoreO;
    sB.textContent=scoreB;
  }

  if(knife){
    for(const b of balls){
      if(Math.hypot(b.x-knife.x,b.y-knife.y)<R+14){
        b.knife=true; b.knifeT=300; knife=null;
        pickupFX.push({x:b.x,y:b.y,a:1,r:0});
        play(420,0.15,0.22);
      }
    }
  }

  pickupFX.forEach(p=>{p.r+=6;p.a-=0.04});
  pickupFX=pickupFX.filter(p=>p.a>0);
  ripples.forEach(r=>{r.r+=3;r.a-=0.04});
  ripples=ripples.filter(r=>r.a>0);

  if(scoreO>=WIN) winner="orange";
  if(scoreB>=WIN) winner="blue";
}

/* ================= DRAW ================= */
function draw(){
  ctx.clearRect(0,0,c.width,c.height);
  ctx.save();
  ctx.translate(c.width/2,c.height/2);

  ctx.strokeStyle="#ffffff33";
  ctx.lineWidth=WALL;
  ctx.strokeRect(-ARENA/2,-ARENA/2,ARENA,ARENA);

  ripples.forEach(r=>{
    ctx.globalAlpha=r.a;
    ctx.beginPath();
    ctx.arc(r.x,r.y,r.r,0,Math.PI*2);
    ctx.strokeStyle="#fff"; ctx.stroke();
  });
  ctx.globalAlpha=1;

  pickupFX.forEach(p=>{
    ctx.globalAlpha=p.a;
    ctx.beginPath();
    ctx.arc(p.x,p.y,p.r,0,Math.PI*2);
    ctx.strokeStyle="#fff"; ctx.stroke();
  });
  ctx.globalAlpha=1;

  for(const b of balls){
    for(let i=0;i<b.trail.length;i++){
      ctx.globalAlpha=(1-i/b.trail.length)*0.3;
      ctx.beginPath();
      ctx.arc(b.trail[i].x,b.trail[i].y,R*(1-i/b.trail.length),0,Math.PI*2);
      ctx.fillStyle=b.color==="orange"?"#ffb000":"#00c8ff";
      ctx.fill();
    }
    ctx.globalAlpha=1;

    if(b.knife){
      ctx.save();
      ctx.translate(b.x,b.y);
      ctx.rotate(b.rot);
      ctx.strokeStyle=b.color==="orange"?"#ffb000":"#00c8ff";
      ctx.lineWidth=3;
      for(let i=0;i<6;i++){
        const a=i*Math.PI*2/6;
        ctx.beginPath();
        ctx.moveTo(Math.cos(a)*(R+4),Math.sin(a)*(R+4));
        ctx.lineTo(Math.cos(a)*(R+28),Math.sin(a)*(R+28));
        ctx.stroke();
      }
      ctx.restore();
    }

    ctx.beginPath();
    ctx.arc(b.x,b.y,R,0,Math.PI*2);
    ctx.fillStyle=b.color==="orange"?"#ffb000":"#00c8ff";
    ctx.fill();
  }

  if(winner){
    ctx.globalAlpha=0.15;
    ctx.fillStyle=winner==="orange"?"#ffb000":"#00c8ff";
    ctx.beginPath();
    ctx.arc(0,0,220,0,Math.PI*2);
    ctx.fill();
  }

  ctx.restore();
}

/* ================= LOOP ================= */
(function loop(){update();draw();requestAnimationFrame(loop)})();
</script>
</body>
</html>


<!-- <!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Ball Arena – Final</title>
<style>
html,body{
  margin:0;
  background:#040407;
  overflow:hidden;
  font-family:Arial,Helvetica,sans-serif;
}
canvas{display:block}

/* SCORE */
#hud{
  position:fixed;
  top:calc(50% - 260px);
  left:0; right:0;
  display:flex;
  justify-content:center;
  gap:120px;
  font-size:26px;
  font-weight:800;
  pointer-events:none;
}
.score{
  transition:transform .2s ease, filter .2s ease;
}
.score.pulse{
  transform:scale(1.35);
  filter:drop-shadow(0 0 16px currentColor);
}
.orange{color:#ffb000}
.blue{color:#00c8ff}

/* WIN */
.overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.85);
  display:flex;
  align-items:center;
  justify-content:center;
  color:#fff;
  font-size:42px;
  z-index:10;
}
.hidden{display:none}
</style>
</head>
<body>

<div id="hud">
  <div class="orange score">ORANGE <span id="sO">0</span></div>
  <div class="blue score">BLUE <span id="sB">0</span></div>
</div>

<div id="end" class="overlay hidden">
  <div id="winner"></div>
</div>

<canvas id="c"></canvas>

<script>
/* ================= SETUP ================= */
const canvas = document.getElementById("c");
const ctx = canvas.getContext("2d");
function resize(){canvas.width=innerWidth;canvas.height=innerHeight}
resize(); addEventListener("resize",resize);

const ARENA = 420;
const WALL  = 10;
const BALL_RADIUS = 18;
const SPEED = 4.6;
const WIN_SCORE = 5;

/* ================= AUDIO ================= */
let audioCtx, audioReady=false, lastSound=0;
window.addEventListener("pointerdown",()=>{
  if(!audioReady){
    audioCtx=new (window.AudioContext||window.webkitAudioContext)();
    audioReady=true;
    play(180,0.05,0.05); // petit click de confirmation
  }
},{once:true});

function play(freq,dur,gain){
  if(!audioReady) return;
  const now=audioCtx.currentTime;
  if(now-lastSound<0.035) return;
  lastSound=now;

  const o=audioCtx.createOscillator();
  const g=audioCtx.createGain();
  o.type="triangle";
  o.frequency.value=freq;
  g.gain.setValueAtTime(0,now);
  g.gain.linearRampToValueAtTime(gain,now+.01);
  g.gain.exponentialRampToValueAtTime(0.0001,now+dur);
  o.connect(g); g.connect(audioCtx.destination);
  o.start(); o.stop(now+dur);
}

/* ================= FX ================= */
let ripples=[], blood=[], pickupFX=[], flash=0;

/* ================= STATE ================= */
let balls=[], weapon=null;
let scoreO=0, scoreB=0;
let nextWeapon=performance.now()+6000;
let running=true;

/* ================= BALL ================= */
function spawnBall(side){
  return{
    x:side==="left"?-140:140,
    y:(Math.random()*140-70),
    vx:side==="left"?SPEED:-SPEED,
    vy:(Math.random()*2-1)*SPEED,
    color:side==="left"?"orange":"blue",
    saw:false,
    sawTime:0,
    rot:0,
    dead:false,
    death:0,
    trail:[]
  };
}
balls=[spawnBall("left"),spawnBall("right")];

/* ================= WEAPON ================= */
function spawnWeapon(){
  weapon={
    x:(Math.random()*220-110),
    y:(Math.random()*220-110),
    t:300
  };
}

/* ================= UPDATE ================= */
function update(){
  if(!running) return;
  const now=performance.now();

  if(!weapon && now>nextWeapon){
    spawnWeapon();
    nextWeapon=now+(6000+Math.random()*4000);
  }
  if(weapon && --weapon.t<=0) weapon=null;

  const a=balls[0], b=balls[1];

  for(const ball of balls){
    if(ball.dead){
      ball.death+=0.05;
      if(ball.death>=1){
        balls[balls.indexOf(ball)] = spawnBall(ball.color==="orange"?"left":"right");
      }
      continue;
    }

    ball.trail.unshift({x:ball.x,y:ball.y});
    if(ball.trail.length>18) ball.trail.pop();

    ball.x+=ball.vx;
    ball.y+=ball.vy;

    if(Math.abs(ball.x)>ARENA/2-BALL_RADIUS){
      ball.x=Math.sign(ball.x)*(ARENA/2-BALL_RADIUS);
      ball.vx*=-1;
      ripples.push({x:ball.x,y:ball.y,r:0,a:1});
      play(240,0.05,0.08);
    }
    if(Math.abs(ball.y)>ARENA/2-BALL_RADIUS){
      ball.y=Math.sign(ball.y)*(ARENA/2-BALL_RADIUS);
      ball.vy*=-1;
      ripples.push({x:ball.x,y:ball.y,r:0,a:1});
      play(240,0.05,0.08);
    }

    if(ball.saw){
      ball.sawTime--;
      ball.rot+=0.6;
      if(ball.sawTime<=0) ball.saw=false;
    }
  }

  /* BALL ↔ BALL COLLISION */
  if(!a.dead && !b.dead){
    const dx=b.x-a.x, dy=b.y-a.y;
    const d=Math.hypot(dx,dy), min=BALL_RADIUS*2;
    if(d<min){
      const nx=dx/d, ny=dy/d;
      const overlap=min-d;
      a.x-=nx*overlap/2; a.y-=ny*overlap/2;
      b.x+=nx*overlap/2; b.y+=ny*overlap/2;

      if(a.saw && !b.saw){
        scoreO++; b.dead=true; a.saw=false;
        blood.push({x:b.x,y:b.y,a:1});
        flash=1; play(90,0.35,0.35);
        document.querySelector(".orange").classList.add("pulse");
      }else if(b.saw && !a.saw){
        scoreB++; a.dead=true; b.saw=false;
        blood.push({x:a.x,y:a.y,a:1});
        flash=1; play(90,0.35,0.35);
        document.querySelector(".blue").classList.add("pulse");
      }else if(a.saw && b.saw){
        a.saw=b.saw=false;
        play(320,0.06,0.1);
      }else{
        const dvx=a.vx-b.vx, dvy=a.vy-b.vy;
        const imp=dvx*nx+dvy*ny;
        if(imp>0){
          a.vx-=imp*nx; a.vy-=imp*ny;
          b.vx+=imp*nx; b.vy+=imp*ny;
        }
        play(260,0.04,0.07);
      }
      document.getElementById("sO").textContent=scoreO;
      document.getElementById("sB").textContent=scoreB;
    }
  }

  /* PICKUP */
  if(weapon){
    for(const ball of balls){
      if(!ball.dead && Math.hypot(ball.x-weapon.x,ball.y-weapon.y)<BALL_RADIUS+14){
        ball.saw=true;
        ball.sawTime=300;
        pickupFX.push({x:ball.x,y:ball.y,a:1,r:0});
        weapon=null;
        play(ball.color==="orange"?420:520,0.18,0.25);
        break;
      }
    }
  }

  pickupFX.forEach(p=>{p.r+=6;p.a-=0.04});
  pickupFX=pickupFX.filter(p=>p.a>0);

  ripples.forEach(r=>{r.r+=3;r.a-=0.04});
  ripples=ripples.filter(r=>r.a>0);

  blood.forEach(b=>b.a-=0.01);
  blood=blood.filter(b=>b.a>0);

  flash*=0.9;

  if(scoreO>=WIN_SCORE||scoreB>=WIN_SCORE){
    document.getElementById("winner").textContent =
      scoreO>scoreB?"ORANGE WINS":"BLUE WINS";
    document.getElementById("end").classList.remove("hidden");
    running=false;
  }
}

/* ================= DRAW ================= */
function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.save();
  ctx.translate(canvas.width/2,canvas.height/2);

  const bg=ctx.createRadialGradient(0,0,80,0,0,canvas.width);
  bg.addColorStop(0,"#0b0b16");
  bg.addColorStop(1,"#040407");
  ctx.fillStyle=bg;
  ctx.fillRect(-canvas.width,-canvas.height,canvas.width*2,canvas.height*2);

  ctx.strokeStyle="#ffffff33";
  ctx.lineWidth=WALL;
  ctx.strokeRect(-ARENA/2,-ARENA/2,ARENA,ARENA);

  ripples.forEach(r=>{
    ctx.globalAlpha=r.a;
    ctx.beginPath();
    ctx.arc(r.x,r.y,r.r,0,Math.PI*2);
    ctx.strokeStyle="#fff";
    ctx.stroke();
  });
  ctx.globalAlpha=1;

  blood.forEach(b=>{
    ctx.globalAlpha=b.a;
    ctx.beginPath();
    ctx.arc(b.x,b.y,36*(1-b.a),0,Math.PI*2);
    ctx.fillStyle="#8b0000";
    ctx.fill();
  });
  ctx.globalAlpha=1;

  pickupFX.forEach(p=>{
    ctx.globalAlpha=p.a;
    ctx.beginPath();
    ctx.arc(p.x,p.y,p.r,0,Math.PI*2);
    ctx.strokeStyle="#fff";
    ctx.stroke();
  });
  ctx.globalAlpha=1;

  if(weapon){
    ctx.save();
    ctx.translate(weapon.x,weapon.y);
    ctx.rotate(Date.now()*0.004);
    ctx.shadowBlur=24;
    ctx.strokeStyle="#ccc";
    ctx.lineWidth=2;
    ctx.beginPath();
    ctx.rect(-14,-5,28,10);
    ctx.stroke();
    for(let i=-12;i<=12;i+=4){
      ctx.beginPath();
      ctx.moveTo(i,-7);
      ctx.lineTo(i,-14);
      ctx.stroke();
    }
    ctx.restore();
  }

  if(flash>0){
    ctx.fillStyle=`rgba(255,255,255,${flash*0.25})`;
    ctx.fillRect(-canvas.width,-canvas.height,canvas.width*2,canvas.height*2);
  }

  for(const b of balls){
    for(let i=0;i<b.trail.length;i++){
      ctx.globalAlpha=(1-i/b.trail.length)*0.25;
      ctx.beginPath();
      ctx.arc(b.trail[i].x,b.trail[i].y,BALL_RADIUS*(1-i/b.trail.length),0,Math.PI*2);
      ctx.fillStyle=b.color==="orange"?"#ffb000":"#00c8ff";
      ctx.fill();
    }
    ctx.globalAlpha=1;

    if(b.saw){
      ctx.save();
      ctx.translate(b.x,b.y);
      ctx.rotate(b.rot);
      const color=b.color==="orange"?"#ff9f00":"#00c8ff";
      ctx.strokeStyle=color;
      ctx.shadowColor=color;
      ctx.shadowBlur=28;
      ctx.lineWidth=3;
      for(let i=0;i<6;i++){
        const a=i*Math.PI*2/6;
        ctx.beginPath();
        ctx.moveTo(Math.cos(a)*(BALL_RADIUS+4),Math.sin(a)*(BALL_RADIUS+4));
        ctx.lineTo(Math.cos(a)*(BALL_RADIUS+28),Math.sin(a)*(BALL_RADIUS+28));
        ctx.stroke();
      }
      ctx.restore();
    }

    if(!b.dead){
      ctx.beginPath();
      ctx.arc(b.x,b.y,BALL_RADIUS,0,Math.PI*2);
      ctx.fillStyle=b.color==="orange"?"#ffb000":"#00c8ff";
      ctx.fill();
    }
  }

  ctx.restore();
}

/* ================= LOOP ================= */
(function loop(){update();draw();requestAnimationFrame(loop)})();
</script>
</body>
</html> -->
