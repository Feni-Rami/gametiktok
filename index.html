<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Escape Rings – Mobile Safe</title>
<style>
html,body{
  margin:0;
  background:#020204;
  overflow:hidden;
  font-family:Arial,Helvetica,sans-serif;
}
canvas{display:block}
#top{
  position:fixed;
  top:18px;
  left:0;right:0;
  text-align:center;
  color:#ffffffcc;
  font-size:18px;
  pointer-events:none;
}
#start{
  position:fixed;
  inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
  background:#020204;
  color:#fff;
  font-size:22px;
  letter-spacing:1px;
  z-index:10;
}
</style>
</head>
<body>

<div id="top">Only one path works</div>
<div id="start">TAP TO START</div>
<canvas id="c"></canvas>

<script>
/* ================= SETUP ================= */
const canvas = document.getElementById("c");
const ctx = canvas.getContext("2d");
function resize(){
  canvas.width = innerWidth;
  canvas.height = innerHeight;
}
resize();
addEventListener("resize", resize);

const CX = () => canvas.width/2;
const CY = () => canvas.height/2;

/* ================= AUDIO (iOS SAFE) ================= */
let audioCtx;
let audioReady = false;
let pitchLevel = 0;
let cameraPulse = 0;

function initAudio(){
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  audioReady = true;
}

function play(freq, dur, gain){
  if(!audioReady) return;
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.type = "sine";
  o.frequency.value = freq;
  g.gain.value = gain;
  o.connect(g);
  g.connect(audioCtx.destination);
  o.start();
  o.stop(audioCtx.currentTime + dur);
}

const bounceSound = () => play(220, 0.04, 0.08);
const hitSound    = () => play(300, 0.04, 0.1);
const exitSound   = () => {
  play(520 + pitchLevel*120, 0.09, 0.18);
  pitchLevel++;
  cameraPulse = 1;
};

/* ================= SETTINGS ================= */
const RING_COUNT = 9;
const GAP_SIZE = Math.PI / 7;
const RING_THICKNESS = 4;

/* Mobile scaling */
const SAFE_MARGIN = 110; // espace pour texte + encoche

function getMaxRadius(){
  return Math.min(canvas.width, canvas.height) / 2 - SAFE_MARGIN;
}

/* Balls */
const BALL_RADIUS = 7;
const BALL_SPEED = 6.2;
const BALL_COUNT = 2;

/* Rotation */
const BASE_ROT_SPEED = 0.0025;

/* Randomness */
const BOUNCE_RANDOM_ANGLE = Math.PI / 18;

/* ================= STATE ================= */
let rings = [];
let balls = [];
let started = false;

/* ================= INIT ================= */
function reset(){
  rings = [];
  balls = [];
  pitchLevel = 0;

  const maxR = getMaxRadius();
  const spacing = maxR / (RING_COUNT + 1);

  for(let i=0;i<RING_COUNT;i++){
    rings.push({
      r: spacing * (i + 1),
      gap: Math.random() * Math.PI * 2,
      rot: BASE_ROT_SPEED * (i + 1)
    });
  }

  for(let i=0;i<BALL_COUNT;i++){
    const a = Math.random() * Math.PI * 2;
    balls.push({
      x: CX() + Math.cos(a) * 30,
      y: CY() + Math.sin(a) * 30,
      vx: Math.cos(a + i) * BALL_SPEED,
      vy: Math.sin(a + i) * BALL_SPEED,
      color: i === 0 ? "#ff9f00" : "#00baff"
    });
  }
}

/* ================= START ================= */
document.getElementById("start").addEventListener("click", ()=>{
  initAudio();
  reset();
  started = true;
  document.getElementById("start").style.display = "none";
});

/* ================= HELPERS ================= */
const dist = (ax,ay,bx,by)=>Math.hypot(ax-bx,ay-by);
const angle = (x,y)=>Math.atan2(y-CY(), x-CX());
function norm(a){
  while(a<-Math.PI) a+=Math.PI*2;
  while(a> Math.PI) a-=Math.PI*2;
  return a;
}

/* ================= UPDATE ================= */
function update(){
  if(!started) return;

  for(const b of balls){
    b.x += b.vx;
    b.y += b.vy;
  }

  /* Ball ↔ Ball collision */
  if(balls.length === 2){
    const a = balls[0], b = balls[1];
    const d = dist(a.x,a.y,b.x,b.y);
    if(d < BALL_RADIUS*2){
      const nx = (b.x-a.x)/d;
      const ny = (b.y-a.y)/d;
      const p = (a.vx*nx + a.vy*ny - b.vx*nx - b.vy*ny);
      a.vx -= p*nx; a.vy -= p*ny;
      b.vx += p*nx; b.vy += p*ny;
      hitSound();
    }
  }

  /* Rings */
  for(let i=rings.length-1;i>=0;i--){
    const ring = rings[i];
    ring.gap += ring.rot;

    for(const b of balls){
      const d = dist(b.x,b.y,CX(),CY());
      const a = angle(b.x,b.y);

      if(Math.abs(d - ring.r) < BALL_RADIUS + RING_THICKNESS){
        const diff = Math.abs(norm(a - ring.gap));

        if(diff > GAP_SIZE/2){
          const nx = (b.x-CX())/d;
          const ny = (b.y-CY())/d;
          const dot = b.vx*nx + b.vy*ny;
          const ang = Math.atan2(b.vy - 2*dot*ny, b.vx - 2*dot*nx);
          const rand = (Math.random()*2 - 1) * BOUNCE_RANDOM_ANGLE;
          b.vx = Math.cos(ang + rand) * BALL_SPEED;
          b.vy = Math.sin(ang + rand) * BALL_SPEED;
          bounceSound();
        } else {
          exitSound();
          rings.splice(i,1);
          return;
        }
      }
    }
  }

  if(rings.length === 0){
    setTimeout(reset, 1200);
  }

  cameraPulse *= 0.9;
}

/* ================= DRAW ================= */
function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  const pulse = 1 + cameraPulse * 0.05;
  ctx.save();
  ctx.translate(CX(), CY());
  ctx.scale(pulse, pulse);
  ctx.translate(-CX(), -CY());

  const bg = ctx.createRadialGradient(CX(),CY(),60,CX(),CY(),canvas.width);
  bg.addColorStop(0,"#0b0d14");
  bg.addColorStop(1,"#020204");
  ctx.fillStyle = bg;
  ctx.fillRect(0,0,canvas.width,canvas.height);

  ctx.lineWidth = RING_THICKNESS;
  ctx.strokeStyle = "#00fff0";
  ctx.shadowColor = "#00fff0";
  ctx.shadowBlur = 12;

  for(const ring of rings){
    ctx.beginPath();
    ctx.arc(
      CX(), CY(),
      ring.r,
      ring.gap + GAP_SIZE/2,
      ring.gap + Math.PI*2 - GAP_SIZE/2
    );
    ctx.stroke();
  }
  ctx.shadowBlur = 0;

  for(const b of balls){
    ctx.beginPath();
    ctx.arc(b.x,b.y,BALL_RADIUS,0,Math.PI*2);
    ctx.fillStyle = b.color;
    ctx.fill();

    ctx.beginPath();
    ctx.arc(b.x,b.y,BALL_RADIUS*2.3,0,Math.PI*2);
    ctx.strokeStyle = b.color + "66";
    ctx.lineWidth = 2;
    ctx.stroke();
  }

  ctx.restore();
}

/* ================= LOOP ================= */
function loop(){
  update();
  draw();
  requestAnimationFrame(loop);
}
loop();
</script>
</body>
</html>
